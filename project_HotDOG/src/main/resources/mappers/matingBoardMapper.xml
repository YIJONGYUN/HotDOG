<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 게시판 네임스페이스(사용영역) 설정 -->

<mapper namespace="com.ybm.hotdog.mappers.MatingBoardMapper">

<!-- 게시글 -->

<!-- 게시물 전체 목록 불러오기 -->
<select id="boardMatingListAll" resultType="Article">
	SELECT 	article_no as articleNo, board_no as boardNo, user_no as userNo, 
			category_no as categoryNo, title, content, reg_date as regDate, hit_count as hitCount,
			"group", step, "order" 
	FROM Article
	WHERE board_no = 3
	ORDER BY "group" desc, "order" asc
</select>

<!-- 게시글 상세 조회 -->
<select id="articleDetail" resultType="Article">
	SELECT 	article_no as articleNo, board_no as boardNo, user_no as userNo, 
			category_no as categoryNo, title, content, reg_date as regDate, hit_count as hitCount,
			"group", step, "order" 
	FROM Article
	WHERE article_no = #{articleNo}
</select>

<!-- 게시글 작성 -->
<insert id="registMating">
	INSERT INTO Article(article_no, board_no, user_no, category_no, title, content, reg_date, hit_count, "group", step, "order") 
	VALUES (seq_Article.nextVal, 3, 1, #{categoryNo}, #{title}, #{content}, sysdate, 0, seq_Article.currVal, 0, 0)
</insert>

<!-- 답글 작성 -->
<insert id="registMatingRearticle">
	INSERT INTO Article(article_no, board_no, user_no, category_no, title, content, reg_date, hit_count, "group", step, "order") 
	VALUES (seq_Article.nextVal, 3, 1, #{categoryNo}, #{title}, #{content}, sysdate, 0, #{articleNo}, #{step} + 1, #{order} + 1)
</insert>

<!-- 답글 계층 및 순서 수정 -->
<update id="updateMatingRearticle">
<![CDATA[
	UPDATE Article 
	SET "order" = "order"+1 
	WHERE "group" = #{group} AND "order" > #{order}
]]>
</update>

<!-- 게시글 삭제 -->
<delete id="deleteMating">
	DELETE FROM Article 
	WHERE article_no = #{articleNo}
</delete>

<!-- 게시글 수정 -->
<update id="updateMating">
	UPDATE Article SET category_no = #{categoryNo}, title = #{title}, content = #{content}, reg_date = sysdate
	WHERE article_no = #{articleNo}
</update>

<!-- 조회수 증가 -->
<update id="updateHitcount">
	UPDATE Article SET hit_count = (hit_count + 1)
	WHERE article_no = #{articleNo}
</update>

<!-- 전체 게시글 수 조회 -->
<select id="getArticleNumber" resultType="Integer">
	SELECT COUNT(article_no)
	FROM Article
	WHERE board_no = 3
</select>

<!-- 게시글 검색 -->
<select id="searchMating" resultType="Article">
	SELECT article_no as articleNo, board_no as boardNo, Article.user_no as userNo, 
		   category_no as categoryNo, title, content, reg_date as regDate, hit_count as hitCount,
		   "group", step, "order" 
	FROM Article, Users
	<include refid="search"></include>
</select>

<sql id="search">
	<choose>
		<when test="searchType=='author'">
			WHERE board_no = 3 
				  AND (Article.user_no = Users.user_no)
				  AND Users.name LIKE '%'||#{keyword}||'%'
			ORDER BY article_no desc, reg_date desc
		</when>
		<otherwise>
			WHERE board_no = 3 
				  AND (Article.user_no = Users.user_no)
				  AND ${searchType} LIKE '%'||#{keyword}||'%'
			ORDER BY article_no desc, reg_date desc
		</otherwise>
	</choose>
</sql>

<!-- 게시글 검색 글 수 조회 -->
<select id="getSearchNumber" resultType="Integer">
	SELECT COUNT(article_no) 
	FROM Article, Users
	<include refid="search" />
</select>


<!-- 댓글 -->

<!-- 댓글 작성 -->
<insert id="registReply">
	INSERT INTO Reply(reply_no, article_no, user_no, content, reg_date) 
	VALUES (seq_Reply.nextVal, #{articleNo}, 1, #{content}, sysdate)
</insert>

<!-- 댓글 조회 -->
<select id="getReply" resultType="Reply">
	SELECT reply_no as replyNo, article_no as articleNo, user_no as userNo, content, reg_date as regDate 
	FROM Reply
	WHERE article_no = #{articleNo}
	ORDER BY reg_date asc
</select>

<!-- 댓글 수 조회 -->
<select id="getReplyNumber" resultType="Integer">
	SELECT COUNT(reply_no) 
	FROM Reply
	WHERE article_no = #{articleNo}
</select>
</mapper>